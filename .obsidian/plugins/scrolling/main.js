/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD!
If you want to view the source, please visit https://github.com/omeyenburg/obsidian-scrolling.
*/
var D=Object.defineProperty;var q=Object.getOwnPropertyDescriptor;var B=Object.getOwnPropertyNames;var X=Object.prototype.hasOwnProperty;var G=(o,t)=>{for(var e in t)D(o,e,{get:t[e],enumerable:!0})},j=(o,t,e,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of B(t))!X.call(o,s)&&s!==e&&D(o,s,{get:()=>t[s],enumerable:!(i=q(t,s))||i.enumerable});return o};var K=o=>j(D({},"__esModule",{value:!0}),o);var J={};G(J,{default:()=>I});module.exports=K(J);var z=require("obsidian");var g=require("obsidian"),k=require("@codemirror/view"),x=require("@codemirror/state");function O(o,t){let e=Object.keys(t).map(i=>$(o,i,t[i]));return e.length===1?e[0]:function(){e.forEach(i=>i())}}function $(o,t,e){let i=o[t],s=o.hasOwnProperty(t),r=s?i:function(){return Object.getPrototypeOf(o)[t].apply(this,arguments)},l=e(r);return i&&Object.setPrototypeOf(l,i),Object.setPrototypeOf(a,l),o[t]=a,h;function a(...d){return l===r&&o[t]===a&&h(),l.apply(this,d)}function h(){o[t]===a&&(s?o[t]=r:delete o[t]),l!==r&&(l=r,Object.setPrototypeOf(a,i||Function))}}function P(o){return o.scrollTop==0}function R(o){return Math.ceil(o.scrollTop+o.clientHeight)>=o.scrollHeight}var E=class E{constructor(t){this.scrollEventSkip=!1;this.lastWheelEventTime=0;this.plugin=t,this.scrollHandler=this.unboundScrollHandler.bind(this),g.Platform.isDesktop&&t.registerDomEvent(document,"wheel",this.wheelHandler.bind(this),{passive:!1}),t.registerDomEvent(document,"keydown",this.keyHandler.bind(this),{passive:!0});let e=t.app.workspace.on("editor-change",()=>{t.app.workspace.offref(e),t.registerEvent(t.app.workspace.on("editor-change",this.editHandler.bind(this)))});t.registerEvent(e),t.registerEditorExtension(k.EditorView.updateListener.of(this.cursorHandler.bind(this))),g.Platform.isDesktop&&t.registerDomEvent(document,"mouseup",this.mouseUpHandler.bind(this),{passive:!0}),t.registerEvent(t.app.workspace.on("active-leaf-change",this.leafChangeHandler.bind(this))),window.requestAnimationFrame(()=>this.attachScrollHandler()),t.registerEvent(t.app.vault.on("delete",this.deleteFileHandler.bind(this))),t.registerEvent(t.app.vault.on("rename",this.renameFileHandler.bind(this))),t.registerEvent(t.app.workspace.on("quit",this.quitHandler.bind(this))),t.registerEvent(t.app.workspace.on("file-open",this.openFileHandler.bind(this)));let i=this;t.register(O(g.WorkspaceLeaf.prototype,{setViewState(s){return async function(...r){let l=await s.apply(this,r);return i.plugin.restoreScroll.viewStateHandler(this.view),l}}})),t.register(O(g.View.prototype,{setEphemeralState(s){return async function(...r){return i.plugin.restoreScroll.ephemeralStateHandler(this,r),await s.apply(this,r)}}}))}attachScrollHandler(){let t=this.plugin.app.workspace.getActiveViewOfType(g.FileView);!t||!t.file||(this.scrollEventSkip=!0,window.setTimeout(()=>this.scrollEventSkip=!1,E.LEAF_CHANGE_SCROLL_EVENT_DELAY),t.file.extension==="md"?this.attachScrollHandlerMarkdown(t):t.file.extension==="pdf"?this.attachScrollHandlerPdf(t):E.IMAGE_EXTENSIONS.has(t.file.extension.toLowerCase())&&this.attachScrollHandlerImage(t))}attachScrollHandlerMarkdown(t){let e=t.contentEl.querySelector(".cm-scroller"),i=t.contentEl.querySelector(".markdown-preview-view");!e||!i||(this.plugin.scrollbar.registerScrollbar(e),this.plugin.scrollbar.registerScrollbar(i),e.removeEventListener("scroll",this.scrollHandler),i.removeEventListener("scroll",this.scrollHandler),this.plugin.registerDomEvent(e,"scroll",this.scrollHandler,{passive:!0}),this.plugin.registerDomEvent(i,"scroll",this.scrollHandler,{passive:!0}))}attachScrollHandlerPdf(t){let e=t.contentEl.querySelector(".pdf-viewer-container");e&&(this.plugin.scrollbar.registerScrollbar(e),e.removeEventListener("scroll",this.scrollHandler),e.addEventListener("scroll",this.scrollHandler),this.plugin.register(()=>e.removeEventListener("scroll",this.scrollHandler)))}attachScrollHandlerImage(t){let e=t.contentEl.querySelector(".image-container")?.parentElement;e&&(this.plugin.scrollbar.registerScrollbar(e),e.removeEventListener("scroll",this.scrollHandler),e.addEventListener("scroll",this.scrollHandler),this.plugin.register(()=>e.removeEventListener("scroll",this.scrollHandler)))}leafChangeHandler(){this.plugin.mouseScroll.leafChangeHandler(),this.plugin.cursorScroll.leafChangeHandler(),this.attachScrollHandler()}unboundScrollHandler(t){this.scrollEventSkip||(this.plugin.scrollbar.scrollHandler(t),this.plugin.restoreScroll.scrollHandler())}openFileHandler(){this.plugin.restoreScroll.openFileHandler()}deleteFileHandler(t){this.plugin.restoreScroll.deleteFileHandler(t)}renameFileHandler(t,e){this.plugin.restoreScroll.renameFileHandler(t,e)}quitHandler(){this.plugin.restoreScroll.quitHandler()}keyHandler(){this.plugin.followCursor.keyHandler()}mouseUpHandler(){this.plugin.followCursor.mouseUpHandler(),this.plugin.restoreScroll.storeStateDebounced()}editHandler(t){this.plugin.followCursor.editHandler(t)}cursorHandler(t){if(this.plugin.cursorScroll.skipCursor){this.plugin.cursorScroll.skipCursor=!1;return}if(t.selectionSet){for(let e of t.transactions)if(e.annotation(x.Transaction.userEvent)==="select.pointer")return;this.plugin.followCursor.cursorHandler(),this.plugin.cursorScroll.cursorHandler()}}isWithinScrollContext(t){return t===this.lastWheelScrollElement||this.lastWheelScrollElement.contains(t)}wheelHandler(t){if(!t.deltaY||!(g.Platform.isDesktop&&this.plugin.settings.mouseEnabled||this.plugin.settings.cursorScrollEnabled))return;let e=t.target,i=performance.now(),s=i-this.lastWheelEventTime;this.lastWheelEventTime=i;let r=this.plugin.mouseScroll.analyzeDelay(s);if(!r&&this.lastWheelScrollElement&&this.isWithinScrollContext(e)&&(t.deltaY<0&&!P(this.lastWheelScrollElement)||t.deltaY>0&&!R(this.lastWheelScrollElement))){this.plugin.mouseScroll.applyCustomScroll(t,this.lastWheelScrollElement,i,s,r),this.plugin.cursorScroll.wheelHandler(this.lastWheelScrollElement);return}for(;e&&e!=document.body;){let{overflowY:l}=getComputedStyle(e);if((l==="auto"||l==="scroll")&&e.scrollHeight>e.clientHeight){if(r){if(t.deltaY<0&&P(e)){e=e.parentElement;continue}if(t.deltaY>0&&R(e)){e=e.parentElement;continue}}this.plugin.mouseScroll.applyCustomScroll(t,e,i,s,r),this.plugin.cursorScroll.wheelHandler(e),this.lastWheelScrollElement=e;return}e=e.parentElement}}};E.LEAF_CHANGE_SCROLL_EVENT_DELAY=500,E.IMAGE_EXTENSIONS=new Set(["png","jpg","jpeg","gif","svg","webp","bmp","ico","apng","avif"]);var T=E;var _=require("obsidian"),f=class f{constructor(t){this.recentEdit=!1;this.recentMouseUp=!1;this.animationFrame=0;this.scrollIntensity=0;this.scrollLastEvent=0;this.plugin=t}keyHandler(){this.recentMouseUp=!1}mouseUpHandler(){this.recentMouseUp=!0,window.setTimeout(()=>this.recentMouseUp=!1,f.MOUSE_UP_TIMEOUT)}editHandler(t){this.recentEdit=!0,this.invokeScroll(t)}cursorHandler(){if(this.recentEdit){this.recentEdit=!1;return}let t=this.plugin.app.workspace.getActiveViewOfType(_.MarkdownView);t?.editor&&(t.file&&this.plugin.restoreScroll.storeStateDebounced(t.file),!(this.recentMouseUp&&!this.plugin.settings.followCursorEnableMouse)&&(!this.plugin.settings.followCursorEnableSelection&&t.editor.somethingSelected()||this.invokeScroll(t.editor)))}invokeScroll(t){if(!this.plugin.settings.followCursorEnabled)return;let e=this.plugin.settings.followCursorDynamicAnimation;!this.recentEdit&&e?this.calculateScrollIntensity():this.scrollIntensity=0;let i=t.cm.scrollDOM.querySelector(".cm-active.cm-line");if(!i)return;let s=i.getBoundingClientRect(),r=t.cm.defaultLineHeight,l=t.cm.scrollDOM.getBoundingClientRect().top,a=s.top+r-l,h=t.getScrollInfo(),d=this.calculateGoalDistance(a,h);if(d===0)return;let S=h.top+d,w=this.calculateSteps(d,h.height);window.cancelAnimationFrame(this.animationFrame),this.animate(t,S,d/w,w)}animate(t,e,i,s){s<=0||(t.scrollTo(null,e-i*(s-1)),this.animationFrame=window.requestAnimationFrame(()=>this.animate(t,e,i,s-1)))}calculateScrollIntensity(){let t=performance.now(),e=t-this.scrollLastEvent;this.scrollLastEvent=t,this.scrollIntensity=Math.max(0,this.scrollIntensity-e*f.INTENSITY_DECAY_RATE)+1}calculateGoalDistance(t,e){let i=this.plugin.settings.followCursorRadius,s=e.height/2*i/100,r=e.height/2,l=t-r,a;if(l<-s)a=l+s;else if(l>s)a=l-s;else return 0;return Math.abs(a)<1?0:a}calculateSteps(t,e){let i=this.plugin.settings.followCursorInstantEditScroll;if(this.recentEdit&&i)return 1;let s=this.plugin.settings.followCursorSmoothness,r=this.plugin.settings.followCursorDynamicAnimation,l=Math.max(1,Math.ceil(2*(s/100)*Math.sqrt(Math.abs(t))));return r&&this.recentEdit&&this.calculateScrollIntensity(),(this.scrollIntensity>f.INTENSITY_THRESHOLD||Math.abs(t)>e)&&(l=Math.ceil(Math.sqrt(l))),l}};f.INTENSITY_DECAY_RATE=.01,f.INTENSITY_THRESHOLD=3,f.MOUSE_UP_TIMEOUT=100;var y=f;var V=require("obsidian"),N=require("@codemirror/state"),b=class b{constructor(t){this.relativeLineOffset=null;this.skipCursor=!1;this.plugin=t,this.resetSkip=(0,V.debounce)(()=>{this.skipCursor=!1},b.CURSOR_SKIP_DELAY,!0),this.wheelHandler=(0,V.debounce)(this.applyScroll.bind(this),b.UPDATE_INTERVAL,!1),window.requestAnimationFrame(this.cursorHandler.bind(this))}leafChangeHandler(){this.relativeLineOffset=null}cursorHandler(){let t=this.plugin.app.workspace.activeEditor?.editor;if(!t)return;let e=t.cm.lineBlockAt(t.posToOffset(t.getCursor())),i=t.cm.scrollDOM,s=(e.top+e.bottom)/2-i.scrollTop+i.getBoundingClientRect().top;this.relativeLineOffset=Math.max(0,Math.min(i.clientHeight,s))}applyScroll(t){if(!this.plugin.settings.cursorScrollEnabled||this.relativeLineOffset==null)return;let e=this.plugin.app.workspace.activeEditor?.editor;if(!e||e.cm.scrollDOM!==t)return;let i=e.cm,s=i.scrollDOM.scrollTop,r=i.scrollDOM.clientHeight,l=s+this.relativeLineOffset;if(l<s||l>s+r)return;let a=i.scrollDOM.getBoundingClientRect(),h={x:a.left+10,y:a.top+this.relativeLineOffset},d=i.posAtCoords(h);if(!d)return;let w=i.state.doc.lineAt(d).number-1;this.setCursorPosition(e,w)}setCursorPosition(t,e){this.skipCursor=!0,this.resetSkip();try{let i=t.cm.state.doc.line(e+1).from,s=N.EditorSelection.single(i);t.cm.dispatch({selection:s,effects:[]})}catch{}}};b.CURSOR_SKIP_DELAY=500,b.UPDATE_INTERVAL=70;var H=b;var W=require("obsidian");function Z(o){return 1-(1-o)**2}function U(o){return o.reduce((t,e)=>t+e,0)/o.length}var n=class n{constructor(t){this.touchpadLastUse=-1/0;this.touchpadFriction=0;this.touchpadVelocity=0;this.touchpadLastAnimation=0;this.touchpadScrolling=!1;this.touchpadAnimation=0;this.mouseLastUse=0;this.intervalSum=null;this.delays=[];this.avgDelay=n.WHEEL_DELAY_THRESHOLD;this.batchSizes=[];this.avgBatchSize=n.BATCH_SIZE_THRESHOLD;this.currentEl=null;this.plugin=t,this.IS_MAC_OS=window.navigator.userAgent.includes("Mac OS")}leafChangeHandler(){this.touchpadVelocity=0,window.cancelAnimationFrame(this.mouseAnimationFrame)}applyCustomScroll(t,e,i,s,r){if(W.Platform.isMobile||!this.plugin.settings.mouseEnabled)return;let l=t.deltaMode==t.DOM_DELTA_LINE?t.deltaY*20:t.deltaY;this.plugin.settings.touchpadEnabled&&this.isTouchpad(t,i,s,r)?this.startTouchpadScroll(e,l):this.startMouseScroll(e,l),t.preventDefault()}startMouseScroll(t,e){if(!t)return;window.cancelAnimationFrame(this.mouseAnimationFrame);let i=this.plugin.settings.mouseSmoothness*2,s=this.plugin.settings.mouseSpeed/50,r=this.plugin.settings.mouseInvert?-1:1,l=performance.now();this.mouseTarget&&this.mouseLastUse&&l-this.mouseLastUse<i&&(t.scrollTop=this.mouseTarget),this.mouseLastUse=l;let a=t.scrollTop,h=e*s*r;this.mouseTarget=a+h,this.animateMouseScroll(t,a,l,i,h)}animateMouseScroll(t,e,i,s,r){let l=performance.now(),a=Math.min(1,(l-i)/s);a=Z(a),t.scrollTop=e+r*a,a<1?this.mouseAnimationFrame=window.requestAnimationFrame(()=>this.animateMouseScroll(t,e,i,s,r)):(t.scrollTop=e+r,this.mouseAnimationFrame=0)}startTouchpadScroll(t,e){t!==this.currentEl&&(window.cancelAnimationFrame(this.touchpadAnimation),window.requestAnimationFrame(this.decoupledTouchpadScroll.bind(this,this.currentEl,this.touchpadVelocity,this.touchpadFriction)),this.currentEl=t,this.touchpadScrolling=!1,this.touchpadVelocity=0,this.touchpadLastAnimation=0);let i=this.plugin.settings.touchpadSmoothness/100,s=this.plugin.settings.touchpadSpeed/200/n.DEFAULT_FRAME_TIME,r=this.plugin.settings.touchpadFrictionThreshold,l=this.plugin.settings.mouseInvert?-1:1;this.touchpadVelocity+=e*s*l,this.touchpadFriction=Math.min(1,(Math.abs(e)/r)**3)*i,(!this.touchpadScrolling||Math.abs(this.touchpadVelocity)<n.MIN_VELOCITY)&&(this.touchpadScrolling=!0,this.animateTouchpadScroll(t))}animateTouchpadScroll(t){if(Math.abs(this.touchpadVelocity)>n.MIN_VELOCITY){let e=performance.now(),i=Math.max(8,Math.min(e-this.touchpadLastAnimation,60));this.touchpadLastAnimation=e;let s=t.scrollTop+this.touchpadVelocity*i;t.scrollTop=s,this.touchpadVelocity*=this.touchpadFriction,this.touchpadFriction=Math.max(0,Math.min(n.MAX_FRICTION,this.touchpadFriction+.05)),this.touchpadAnimation=window.requestAnimationFrame(()=>this.animateTouchpadScroll(t))}else this.touchpadScrolling=!1,this.touchpadVelocity=0,this.touchpadLastAnimation=0,this.touchpadAnimation=0}decoupledTouchpadScroll(t,e,i){Math.abs(e)>n.MIN_VELOCITY&&(t.scrollTop=t.scrollTop+e*n.DEFAULT_FRAME_TIME,e*=i,i=Math.max(0,Math.min(n.MAX_FRICTION,i+.05)),window.setTimeout(()=>this.decoupledTouchpadScroll(t,e,i),n.DEFAULT_FRAME_TIME))}isTouchpad(t,e,i,s){if(t.deltaMode!==WheelEvent.DOM_DELTA_PIXEL)return this.touchpadLastUse=0,!1;if(t.deltaX!==0&&t.deltaY!==0)return this.touchpadLastUse=e,!0;if(e-this.touchpadLastUse<n.TOUCHPAD_GRACE_PERIOD)return this.touchpadLastUse=e,!0;let r=this.getIntensity(i,t.deltaY);return s?r+=.1:this.avgDelay>n.WHEEL_DELAY_THRESHOLD&&(r+=.2),this.avgBatchSize<n.BATCH_SIZE_THRESHOLD&&(r+=.1),t.deltaY%120===0&&(r+=.3),this.IS_MAC_OS&&(r-=.1),r+=Math.max(0,Math.abs(t.deltaY/200)-.5),r<1.1?(r<.7&&(this.touchpadLastUse=e),!0):!1}getIsStart(t){let e=Math.min(n.MIN_START_TRESHOLD+this.avgDelay,n.MAX_START_TRESHOLD);return t>e}analyzeDelay(t){let e=this.getIsStart(t);return e?(this.batchSizes.push(this.delays.length),this.batchSizes.length>n.MAX_BATCH_SIZE_SAMPLES&&this.batchSizes.shift(),this.avgBatchSize=U(this.batchSizes),this.delays=[],this.avgDelay=n.WHEEL_DELAY_THRESHOLD,!0):(this.delays.push(t),this.delays.length>n.MAX_DELAY_SAMPLES&&this.delays.shift(),this.avgDelay=U(this.delays),e)}getIntensity(t,e){return t<n.MAX_INTENSITY_INTERVAL&&this.intervalSum!==null?this.intervalSum=this.intervalSum*(1-n.INTENSITY_SMOOTHING)+t*n.INTENSITY_SMOOTHING*Math.max(Math.pow(e,2)):this.intervalSum=Math.max(Math.pow(e,2),1),Math.log2(this.intervalSum)/20}};n.MAX_FRICTION=.98,n.MIN_VELOCITY=.01,n.TOUCHPAD_GRACE_PERIOD=50,n.MIN_START_TRESHOLD=200,n.MAX_START_TRESHOLD=500,n.MAX_INTENSITY_INTERVAL=600,n.INTENSITY_SMOOTHING=.3,n.WHEEL_DELAY_THRESHOLD=10,n.MAX_DELAY_SAMPLES=50,n.BATCH_SIZE_THRESHOLD=20,n.MAX_BATCH_SIZE_SAMPLES=3,n.DEFAULT_FRAME_TIME=16.67;var L=n;var M=require("obsidian"),F=class F{constructor(t){this.currentWidth=0;this.currentVisibility="";this.currentFileTreeHorizontal=!1;this.scrollTimeouts=new Map;this.plugin=t,this.updateStyle()}registerScrollbar(t){t.classList.add("scrolling-transparent")}scrollHandler(t){this.showScrollbarTemporary(t)}showScrollbarTemporary(t){if(M.Platform.isMacOS||this.plugin.settings.scrollbarVisibility!="scroll")return;let e=t.currentTarget;if(!e)return;let i=this.scrollTimeouts.get(e);i&&window.clearTimeout(i),e.classList.remove("scrolling-transparent");let s=window.setTimeout(()=>this.hideScrollbarTemporary(e),F.SCROLLBAR_IDLE_TIMEOUT);this.scrollTimeouts.set(e,s)}hideScrollbarTemporary(t){t.classList.add("scrolling-transparent"),this.scrollTimeouts.delete(t)}updateStyle(){if(M.Platform.isMacOS){let s=this.plugin.settings.scrollbarFileTreeHorizontal;if(this.currentFileTreeHorizontal==s)return;this.currentFileTreeHorizontal=s,s?document.body.addClass("scrolling-filetree-horizontal"):document.body.removeClass("scrolling-filetree-horizontal");return}let t=this.plugin.settings.scrollbarVisibility,e=M.Platform.isLinux?this.plugin.settings.scrollbarWidth:-1,i=this.plugin.settings.scrollbarFileTreeHorizontal;this.currentWidth==e&&this.currentVisibility==t&&this.currentFileTreeHorizontal==i||(this.currentWidth=e,this.currentVisibility=t,this.currentFileTreeHorizontal=i,this.removeStyle(),i&&document.body.addClass("scrolling-filetree-horizontal"),t==="hide"?document.body.addClass("scrolling-visibility-hide"):t==="scroll"&&document.body.addClass("scrolling-visibility-scroll"),e>=0&&(document.body.addClass("scrolling-scrollbar-width"),document.body.style.setProperty("--scrolling-scrollbar-width",`${e}px`)))}removeStyle(){document.body.removeClasses(["scrolling-scrollbar-width","scrolling-visibility-hide","scrolling-visibility-scroll","scrolling-filetree-horizontal"]),document.body.style.removeProperty("--scrolling-scrollbar-width")}};F.SCROLLBAR_IDLE_TIMEOUT=500;var A=F;var c=require("obsidian");function Y(o){switch(o.getViewType()){case"markdown":return o.containerEl.querySelector(".markdown-preview-view");case"pdf":return o.containerEl.querySelector(".pdf-viewer-container");case"image":return o.containerEl.querySelector(".image-container")?.parentElement;default:return null}}var m=class m{constructor(t){this.ephemeralStates={};this.skipViewSet=!1;this.expectEphemeralState=!0;this.plugin=t,this.storeStateDebounced=(0,c.debounce)(this.storeState.bind(this),m.STORE_INTERVAL,!1),this.writeStateFileDebounced=(0,c.debounce)(this.writeStateFile.bind(this),m.FILE_WRITE_INTERVAL,!0)}scrollHandler(){let t=this.plugin.app.workspace.getActiveFile();t&&(this.plugin.restoreScroll.storeStateDebounced(t),this.plugin.restoreScroll.writeStateFileDebounced())}openFileHandler(){this.expectEphemeralState=!0,window.setTimeout(()=>this.expectEphemeralState=!1,0)}ephemeralStateHandler(t,e){if(!this.expectEphemeralState||!e[0])return;if(this.expectEphemeralState=!1,this.plugin.app.workspace.containerEl.querySelector("span.is-flashing")||this.plugin.settings.restoreScrollMode==="top"){this.skipViewSet=!0,window.setTimeout(()=>this.skipViewSet=!1,0);return}if(!(t instanceof c.MarkdownView)||!t.file||t.getMode()!=="source")return;this.skipViewSet=!0,window.setTimeout(()=>this.skipViewSet=!1,0);let s=this.ephemeralStates[t.file.path];if(!s)return;let{cursor:r,scroll:l}=s;this.plugin.settings.restoreScrollMode==="bottom"?(e[0].cursor=void 0,e[0].focus=!1,e[0].scroll=1/0):r&&this.plugin.settings.restoreScrollMode==="cursor"?(delete e[0].scroll,e[0].focus=!0,e[0].cursor=r,window.requestAnimationFrame(()=>t.editor.scrollIntoView(r,!0))):(e[0].cursor=void 0,e[0].focus=!1,e[0].scroll=l)}viewStateHandler(t){if(this.writeStateFileDebounced(),this.skipViewSet||this.plugin.settings.restoreScrollMode==="top"||!t||!(t instanceof c.FileView)||!t.file)return;let e=this.ephemeralStates[t.file.path];if(!e)return;let{cursor:i,scroll:s,scrollTop:r}=e;t instanceof c.MarkdownView&&t.getMode()==="source"&&(s||i)?i&&this.plugin.settings.restoreScrollMode==="cursor"?(t.setEphemeralState({cursor:i,focus:!0}),t.editor.scrollIntoView(i,!0)):t.setEphemeralState({scroll:s}):r&&this.plugin.settings.restoreScrollAllFiles&&window.requestAnimationFrame(()=>{let l=Y(t);l&&(l.scrollTop=r)})}deleteFileHandler(t){delete this.ephemeralStates[t.path]}renameFileHandler(t,e){this.ephemeralStates[t.path]=this.ephemeralStates[e],delete this.ephemeralStates[e]}quitHandler(){this.writeStateFile()}async writeStateFile(){if(!this.plugin.settings.restoreScrollFileEnabled)return;let t=JSON.stringify(this.ephemeralStates);this.plugin.app.vault.adapter.write(this.plugin.settings.restoreScrollFilePath,t)}async loadData(){if(!await this.plugin.app.vault.adapter.exists(this.plugin.settings.restoreScrollFilePath))if(await this.plugin.app.vault.adapter.exists(m.FALLBACK_FILE_PATH))this.plugin.settings.restoreScrollFilePath=m.FALLBACK_FILE_PATH;else return;let t=this.plugin.settings.restoreScrollFilePath;try{let e=await this.plugin.app.vault.adapter.read(t);this.ephemeralStates=JSON.parse(e)}catch{this.ephemeralStates={}}}storeState(t){let e=this.plugin.settings.restoreScrollMode;if(e==="top"||e==="bottom")return;let i=this.plugin.app.workspace.getActiveViewOfType(c.FileView);if(!i||!i.file||i.file!==this.plugin.app.workspace.getActiveFile()||t&&i.file!==t)return;let s=Date.now();if(i instanceof c.MarkdownView&&i.getMode()=="source"){let r=i.editor.getScrollInfo().top,{cursor:l,scroll:a}=i.getEphemeralState();this.ephemeralStates[i.file.path]={timestamp:s,cursor:l,scroll:a,scrollTop:r}}else if(this.plugin.settings.restoreScrollAllFiles){let r=Y(i)?.scrollTop;r&&(this.ephemeralStates[i.file.path]={timestamp:s,scrollTop:r})}this.discardOldStates()}discardOldStates(){let t=Object.entries(this.ephemeralStates);this.plugin.settings.restoreScrollLimit<=0||t.length<=this.plugin.settings.restoreScrollLimit||(t.sort(([,e],[,i])=>i.timestamp-e.timestamp),this.ephemeralStates=Object.fromEntries(t.slice(0,this.plugin.settings.restoreScrollLimit)))}countEphemeralStates(){return Object.keys(this.ephemeralStates).length}async renameStoreFile(t){if(!this.plugin.settings.restoreScrollFileEnabled)return;if(t===null){new c.Notice("Path unchanged.");return}if(!t||t.trim()===""||t==="."||t===".."){new c.Notice("Invalid file path!");return}let e=(0,c.normalizePath)(t),i=(0,c.normalizePath)(this.plugin.settings.restoreScrollFilePath);if(!e){new c.Notice("Invalid file path!");return}let s=this.plugin.app.vault.adapter,r=e.substring(0,e.lastIndexOf("/"));if(!r||!await s.exists(r)){new c.Notice(`Directory does not exist: ${r}`);return}if(await s.exists(e)){new c.Notice(`File already exists: ${e}`);return}if(i&&await s.exists(i))try{await s.rename(i,e)}catch{new c.Notice("Invalid file path!");return}return new c.Notice(`Renamed storage file to: ${e}`),e}};m.STORE_INTERVAL=97,m.FILE_WRITE_INTERVAL=293,m.DEFAULT_FILE_PATH=".obsidian/plugins/scrolling/scrolling-positions.json",m.FALLBACK_FILE_PATH=".obsidian/plugins/obsidian-scrolling/scrolling-positions.json";var v=m;var u=require("obsidian");var p={followCursorEnabled:!0,followCursorRadius:75,followCursorSmoothness:25,followCursorInstantEditScroll:!0,followCursorDynamicAnimation:!0,followCursorEnableMouse:!1,followCursorEnableSelection:!1,cursorScrollEnabled:!1,restoreScrollMode:"scroll",restoreScrollLimit:-1,restoreScrollAllFiles:!1,restoreScrollFileEnabled:!0,restoreScrollFilePath:v.DEFAULT_FILE_PATH,scrollbarVisibility:"show",scrollbarWidth:12,scrollbarFileTreeHorizontal:!1,mouseEnabled:!1,mouseInvert:!1,mouseSpeed:50,mouseSmoothness:75,touchpadEnabled:!0,touchpadSmoothness:75,touchpadFrictionThreshold:20,touchpadSpeed:50},C=class extends u.PluginSettingTab{constructor(e){super(e.app,e);this.settingsEnabled=!0;this.proposedRestoreScrollStoreFile=null;this.plugin=e}display(){let e=this.containerEl.scrollTop;this.containerEl.empty(),this.followCursorSettings(),this.cursorScrollSettings(),this.restoreScrollSettings(),this.scrollbarSettings(),this.mouseScrollSettings(),this.createHeading("Issues & feature requests").setDesc(createFragment(i=>{i.createEl("span",{text:"To report bugs or provide feedback, please use the "}),i.createEl("a",{text:"issue tracker",href:"https://github.com/omeyenburg/obsidian-scrolling/issues"}),i.createEl("span",{text:" and the "}),i.createEl("a",{text:"discussion page",href:"https://github.com/omeyenburg/obsidian-scrolling/discussions"}),i.createEl("span",{text:"."})})),this.containerEl.scrollTop=e}setDesc(e,i){if(!i)return;if(!i.includes(`
`)){e.setDesc(i);return}let s=i.split(`
`);e.setDesc(createFragment(r=>s.forEach((l,a)=>{r.createEl("span",{text:l}),a<s.length-1&&r.createEl("br")})))}createHeading(e,i){let s=new u.Setting(this.containerEl).setName(e).setHeading();return this.setDesc(s,i),this.settingsEnabled=!0,s}createSetting(e,i,s){let r=new u.Setting(this.containerEl).setName(e);return this.setDesc(r,i),s&&r.addExtraButton(l=>{l.setIcon("reset").onClick(async()=>{s(),this.display(),await this.plugin.saveSettings()}),this.settingsEnabled&&l.setTooltip("Restore default")}),this.settingsEnabled?window.setTimeout(()=>{r.components.forEach(l=>{l instanceof u.SliderComponent&&l.setDynamicTooltip()})},1):(r.infoEl.style.opacity="0.4",r.controlEl.style.opacity="0.4",r.controlEl.style.filter="grayscale(100%)",window.setTimeout(()=>{r.components.forEach(l=>{l.setDisabled(!0)})},1)),r}followCursorSettings(){this.createHeading("Scroll follows text cursor"),this.createSetting("Enable",`Scroll the view to keep the cursor near the center when you move the cursor.
Can be used together with 'Text cursor follows scroll'.`).addToggle(e=>e.setValue(this.plugin.settings.followCursorEnabled).onChange(async i=>{this.plugin.settings.followCursorEnabled=i,this.display(),await this.plugin.saveSettings()})),this.settingsEnabled=this.plugin.settings.followCursorEnabled,this.createSetting("Trigger distance",`How far the cursor can move from the center before scrolling (%).
0% keeps the cursor perfectly centered.`,()=>this.plugin.settings.followCursorRadius=p.followCursorRadius).addSlider(e=>e.setValue(this.plugin.settings.followCursorRadius).setLimits(0,100,1).onChange(async i=>{this.plugin.settings.followCursorRadius=i,await this.plugin.saveSettings()})),this.createSetting("Animation smoothness","Duration of the scroll animation.",()=>this.plugin.settings.followCursorSmoothness=p.followCursorSmoothness).addSlider(e=>e.setValue(this.plugin.settings.followCursorSmoothness).setLimits(0,100,1).onChange(async i=>{this.plugin.settings.followCursorSmoothness=i,await this.plugin.saveSettings()})),this.createSetting("Instant scroll on edit","Do not scroll smoothly while editing text.").addToggle(e=>e.setValue(this.plugin.settings.followCursorInstantEditScroll).onChange(async i=>{this.plugin.settings.followCursorInstantEditScroll=i,await this.plugin.saveSettings()}))}cursorScrollSettings(){u.Platform.isMobile||(this.containerEl.createEl("br"),this.createHeading("Text cursor follows scroll"),this.createSetting("Enable",`Move the cursor to stay visible when scrolling manually.
Can be used together with 'Scroll follows text cursor'.`).addToggle(e=>e.setValue(this.plugin.settings.cursorScrollEnabled).onChange(async i=>{this.plugin.settings.cursorScrollEnabled=i,await this.plugin.saveSettings()})))}restoreScrollSettings(){this.containerEl.createEl("br"),this.createHeading("Remember scroll/cursor position","Automatically save your position before closing a file and restore it upon opening the file again."),this.createSetting("Mode","Start at the top/bottom of the file, or restore the cursor or scroll position.",()=>this.plugin.settings.restoreScrollMode=p.restoreScrollMode).addDropdown(i=>i.addOption("top","Start at top (Obsidian's default)").addOption("bottom","Start at bottom").addOption("cursor","Restore cursor position").addOption("scroll","Restore scroll position").setValue(this.plugin.settings.restoreScrollMode).onChange(async s=>{this.plugin.settings.restoreScrollMode=s,this.display(),await this.plugin.saveSettings()})),this.settingsEnabled=["scroll","cursor"].includes(this.plugin.settings.restoreScrollMode);let e=this.plugin.restoreScroll.countEphemeralStates();this.createSetting("Saved positions limit",`Number of files to remember scroll positions for. Leave empty for unlimited.
Currently positions for ${e} file${e==1?"":"s"} are stored.`,()=>this.plugin.settings.restoreScrollLimit=p.restoreScrollLimit).addText(i=>{i.setPlaceholder("Unlimited").setValue(this.plugin.settings.restoreScrollLimit>0?this.plugin.settings.restoreScrollLimit.toString():"").onChange(s=>{let r=+s;if(!r.toString().contains(".")){if(r<=0){this.plugin.settings.restoreScrollLimit=-1;return}this.plugin.settings.restoreScrollLimit=r}})}),this.createSetting("Restore position in other files","Enable restoring scroll position in Markdown preview, images, and PDFs.").addToggle(i=>i.setValue(this.plugin.settings.restoreScrollAllFiles).onChange(async s=>{this.plugin.settings.restoreScrollAllFiles=s,await this.plugin.saveSettings()})),this.createSetting("Store positions in file","Save positions inside a file to keep them after Obsidian restarts.").addToggle(i=>i.setValue(this.plugin.settings.restoreScrollFileEnabled).onChange(async s=>{this.plugin.settings.restoreScrollFileEnabled=s,this.display(),await this.plugin.saveSettings()})),this.settingsEnabled&&=this.plugin.settings.restoreScrollFileEnabled,this.createSetting("Storage file path","Where to store scrolling & cursor positions.").addText(i=>{i.setValue(this.plugin.settings.restoreScrollFilePath).onChange(S=>{this.proposedRestoreScrollStoreFile=S});let s=async()=>{let S=await this.plugin.restoreScroll.renameStoreFile(this.proposedRestoreScrollStoreFile);S&&(this.plugin.settings.restoreScrollFilePath=S,this.proposedRestoreScrollStoreFile=null,await this.plugin.saveSettings())},r=S=>{S.key==="Enter"&&s()};i.inputEl.addEventListener("keydown",r),this.plugin.register(()=>i.inputEl.removeEventListener("keydown",r));let l;i.inputEl.parentElement?(l=i.inputEl.parentElement,l.style.display="flex",l.style.alignItems="flex-end",l.style.flexDirection="column",l.style.marginBottom="-1.5em"):l=this.containerEl;let a=l.createDiv({cls:"setting-item-control"});a.style.display="flex";let h=a.createDiv({cls:"clickable-icon extra-setting-button"});this.settingsEnabled&&h.setAttr("aria-label","Cancel changes"),(0,u.setIcon)(h,"reset"),h.onclick=()=>{this.proposedRestoreScrollStoreFile!==null&&(i.setValue(this.plugin.settings.restoreScrollFilePath),this.proposedRestoreScrollStoreFile=null)};let d=a.createEl("button",{text:"Confirm"});d.onclick=s,d.disabled=!this.settingsEnabled})}scrollbarSettings(){this.containerEl.createEl("br"),this.createHeading("Scrollbar appearance"),u.Platform.isMacOS||this.createSetting("Scrollbar visibility","When to show the scrollbar in notes and PDFs.",()=>{this.plugin.settings.scrollbarVisibility=p.scrollbarVisibility,this.plugin.scrollbar.updateStyle()}).addDropdown(e=>e.addOption("hide","Always hide scrollbar").addOption("scroll","Show scrollbar while scrolling").addOption("show","Always show scrollbar").setValue(this.plugin.settings.scrollbarVisibility).onChange(async i=>{this.plugin.settings.scrollbarVisibility=i,this.plugin.scrollbar.updateStyle(),this.display(),await this.plugin.saveSettings()})),u.Platform.isLinux&&u.Platform.isDesktop&&(this.settingsEnabled=this.plugin.settings.scrollbarVisibility!=="hide",this.createSetting("Scrollbar thickness","Scrollbar width in pixels.",()=>{this.plugin.settings.scrollbarWidth=p.scrollbarWidth,this.plugin.scrollbar.updateStyle()}).addSlider(e=>e.setValue(this.plugin.settings.scrollbarWidth).setLimits(0,30,1).onChange(async i=>{this.plugin.settings.scrollbarWidth=i,this.plugin.scrollbar.updateStyle(),await this.plugin.saveSettings()}))),u.Platform.isDesktop&&this.createSetting("Horizontal scrollbar in file tree","Allow horizontal scrolling in the file tree and show the scrollbar.").addToggle(e=>e.setValue(this.plugin.settings.scrollbarFileTreeHorizontal).onChange(async i=>{this.plugin.settings.scrollbarFileTreeHorizontal=i,this.plugin.scrollbar.updateStyle(),await this.plugin.saveSettings()}))}mouseScrollSettings(){u.Platform.isMobile||(this.containerEl.createEl("br"),this.createHeading("Mouse & Touchpad (Experimental)"),this.createSetting("Enable","Enable custom scrolling behavior.").addToggle(e=>e.setValue(this.plugin.settings.mouseEnabled).onChange(async i=>{this.plugin.settings.mouseEnabled=i,this.display(),await this.plugin.saveSettings()})),this.settingsEnabled=this.plugin.settings.mouseEnabled,this.createSetting("Mouse scroll speed","How far the page scrolls.",()=>this.plugin.settings.mouseSpeed=p.mouseSpeed).addSlider(e=>e.setValue(this.plugin.settings.mouseSpeed).setLimits(1,100,1).onChange(async i=>{this.plugin.settings.mouseSpeed=i,await this.plugin.saveSettings()})),this.createSetting("Mouse scroll smoothness","Duration of the scroll animation.",()=>this.plugin.settings.mouseSmoothness=p.mouseSmoothness).addSlider(e=>e.setValue(this.plugin.settings.mouseSmoothness).setLimits(0,100,1).onChange(async i=>{this.plugin.settings.mouseSmoothness=i,await this.plugin.saveSettings()})),this.createSetting("Touchpad scroll speed","How far the page scrolls.",()=>this.plugin.settings.touchpadSpeed=p.touchpadSpeed).addSlider(e=>e.setValue(this.plugin.settings.touchpadSpeed).setLimits(1,100,1).onChange(async i=>{this.plugin.settings.touchpadSpeed=i,await this.plugin.saveSettings()})),this.createSetting("Touchpad scroll smoothness","Duration of the scroll animation.",()=>this.plugin.settings.touchpadSmoothness=p.touchpadSmoothness).addSlider(e=>e.setValue(this.plugin.settings.touchpadSmoothness).setLimits(0,100,1).onChange(async i=>{this.plugin.settings.touchpadSmoothness=i,await this.plugin.saveSettings()})),this.createSetting("Touchpad friction threshold",`Threshold between precise and smooth scrolling.
Defines how much finger movement is needed before scrolling decelerates and stops.`,()=>this.plugin.settings.touchpadFrictionThreshold=p.touchpadFrictionThreshold).addSlider(e=>e.setValue(this.plugin.settings.touchpadFrictionThreshold).setLimits(1,100,1).onChange(async i=>{this.plugin.settings.touchpadFrictionThreshold=i,await this.plugin.saveSettings()})))}};var I=class extends z.Plugin{async onload(){await this.loadSettings(),this.addSettingTab(new C(this)),this.restoreScroll=new v(this),this.cursorScroll=new H(this),this.followCursor=new y(this),this.mouseScroll=new L(this),this.scrollbar=new A(this),new T(this),await this.restoreScroll.loadData(),console.log("ScrollingPlugin loaded")}async onunload(){this.scrollbar?.removeStyle(),this.restoreScroll.quitHandler(),console.log("ScrollingPlugin unloaded")}async loadSettings(){this.settings=Object.assign({},p,await this.loadData());for(let t in this.settings)t in p||delete this.settings[t]}async saveSettings(){await this.saveData(this.settings)}};

/* nosourcemap */